#include <stdio.h>
#include <windows.h>
#include "TADColaEst.h"

void gotoxy(int x, int y); // Funcion para imprimir en una cierta posición
int vacio(int q);

#define Tiempobase 10 //Tiempo base base del problema
#define impresion 20 // cada 20 se imprimira los nuevo usuarios
int cerrar = 2000;

void main()
{
	elemento e;
	cola preferentes;
	Initialize(&preferentes);
	cola usuarios;
	Initialize(&usuarios);
	cola clientes;
	Initialize(&clientes);
	int i, cajeras, Tiempocliente[3];
	unsigned int base_time = 0;

//Número de cajeros que atienden
	printf("Ingrese el numero de cajeros");
	scanf("%d", &cajeras);

	int Tiempocajero[cajeras];
	int cajerovacio[cajeras];
for (int i = 0; i < cajeras; ++i)
{
	cajerovacio[i] = 0;
}
	// 0 = Clientes, 1 = Usuarios, 2 = Preferentes;
	printf("Ingrese el tiempo de llegada de clientes");
	scanf("%d", &Tiempocliente[0]);

	printf("Ingrese el tiempo de llegada de usuarios");
	scanf("%d", &Tiempocliente[1]);

	printf("Ingrese el tiempo de llegada de preferentes");
	scanf("%d", &Tiempocliente[2]);

	int c = 0, p = 0, u = 0;		//auxiliares para clientes
	int Pa = 0, Ua = 0;				//auxiliares para clientes

 //Inicializamos cajeros y pedimos el tiempo de cada uno
	for(i=0; i < cajeras; i++)
	{
		printf("Ingrese el tiempo del cajero %d", i);
		scanf("%d", &Tiempocajero[i]);
	}

e.tipoP = 0;
e.tipoU = 0;
e.tipoC = 0;
	system("cls");
	while(1){
		Sleep(Tiempobase);
		base_time++;

		//atencion de clientes
		for(i=0; i < cajeras; i++)
		{
			if(base_time % Tiempocajero[i] == 0)
			{
				cajerovacio[i] = 0;
				if(Pa < 3 && !Empty(&preferentes))
				{
					e = Dequeue(&preferentes);
					Pa++;
					cajerovacio[i] = e.n;
					gotoxy(50,20);
					printf("P%d", e.tipoP);
				}
				else
					if((!Empty(&usuarios) && Ua < 2) || (!Empty(&usuarios) && vacio(cajerovacio[i]) == 1))
					{
						e = Dequeue(&usuarios);
						Ua++;
						gotoxy(50,20);
						printf("U%d", e.tipoU);
					}
				if (!Empty(&clientes) && Pa+Ua == 5)
					{
						e = Dequeue(&clientes);
						gotoxy(50,20);
						printf("C%d", e.tipoC);
						Pa = 0;
						Ua = 0;
						Sleep(Tiempocajero[i]);
					}
			}
		}
		// Tiempocliente[0] = Clientes, Tiempocliente[1] = Usuarios, Tiempocliente[2] = Preferentes;
		// Encolamos a los visitantes
		if(base_time % Tiempocliente[0] == 0)
		{
			c++;
			e.tipoC = c;
			e.n = 0;
			Queue(&clientes, e);
		}

		if (base_time % Tiempocliente[1] == 0)
		{
			u++;
			e.tipoU = u;
			e.n = 1;
			Queue(&usuarios, e);
		}

		if (base_time % Tiempocliente[2] == 0)
		{
			p++;
			e.tipoP = p;
			e.n = 2;
			Queue(&preferentes, e);
		}
		//Fin del encolamiento

		//impresion de las colas
		if(base_time % impresion == 0)
		{
			for(i=1; i<=Size(&preferentes); i++)
				{
					if (e.tipoP<=20)
					{
						gotoxy(10,10+p);
						printf("%d", e.tipoP);
					}
					else
						gotoxy(10,10+20);
						printf("Y %d mas", (e.tipoP-20));
				}
			for(i=1; i<=Size(&usuarios); i++)
			{
				if (e.tipoU<=20)
				{
					gotoxy(35,10+u);
					printf("%d", e.tipoU);
				}
				else
					gotoxy(35,10+20);
					printf("Y %d mas", (e.tipoU-20));
			}
			for(i=1; i<=Size(&clientes); i++)
				{
					if (e.tipoC<=20)
					{
						gotoxy(25,10+c);
						printf("%d", e.tipoC);
					}
					else
						gotoxy(25,10+20);
						printf("Y %d mas", (e.tipoC-20));
				}
		}
	}
	return;
}
void gotoxy(int x, int y) 
{
	HANDLE hStdout = GetStdHandle(STD_OUTPUT_HANDLE);
	COORD position = { x, y }; 
	SetConsoleCursorPosition( hStdout, position );
	return;
};
int vacio(int q)
{
	int band1;
	if(q==0)
		band1 = 1;
	else
		band1 = 0;
	return band1;
}
